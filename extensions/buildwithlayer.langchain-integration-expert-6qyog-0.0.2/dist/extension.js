"use strict";var A=Object.create;var C=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var q=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,I=Object.prototype.hasOwnProperty;var L=(t,e)=>{for(var n in e)C(t,n,{get:e[n],enumerable:!0})},S=(t,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of q(e))!I.call(t,r)&&r!==n&&C(t,r,{get:()=>e[r],enumerable:!(i=H(e,r))||i.enumerable});return t};var w=(t,e,n)=>(n=t!=null?A(D(t)):{},S(e||!t||!t.__esModule?C(n,"default",{value:t,enumerable:!0}):n,t)),U=t=>S(C({},"__esModule",{value:!0}),t);var B={};L(B,{activate:()=>W});module.exports=U(B);var T=w(require("vscode"));var f=w(require("vscode"));var x=w(require("fs"));var N="5c04725a-365d-42e3-b440-08e8020cfb5a",P="langchain-integration-expert-6Qyog",k="production";function j(t){return t&&typeof t=="object"&&t.path&&typeof t.path=="string"?t.path:""}function F(t){return t&&typeof t=="object"&&t.uri&&typeof t.uri.path=="string"?t.uri.path:""}var g=class t{static ENVIRONMENT_MAP=new Map([["development","http://localhost"],["staging","https://api.staging.buildwithlayer.com"],["production","https://api.buildwithlayer.com"]]);apiKey=N;environment=k;customer;constructor(){this.getCustomerName().then(e=>{this.customer=e})}getBaseUrl(){let e=t.ENVIRONMENT_MAP.get(this.environment);if(e===void 0)throw new Error(`Invalid environment: ${this.environment}`);return e}headers(){let e=new Headers;return e.set("Layer-Api-Key",this.apiKey),e}getHeaders(){let e=this.headers();return e.set("Accept","application/json"),e}getRequest(e){return new Request(`${this.getBaseUrl()}/${e}`,{method:"GET",headers:this.getHeaders()})}postJSONRequest(e,n){let i=this.getHeaders();return i.set("Content-Type","application/json"),new Request(`${this.getBaseUrl()}/${e}`,{method:"POST",headers:i,body:JSON.stringify(n)})}postFormRequest(e,n){let i=this.headers();return i.set("Accept","text/event-stream"),new Request(`${this.getBaseUrl()}/${e}`,{method:"POST",headers:i,body:n})}async getCustomerName(){return fetch(this.getRequest("customers/")).then(e=>e.json()).then(e=>e).then(e=>e.company_name)}async search(e,n=10){let i={history:e,top_n:n};return fetch(this.postJSONRequest("chat/search",i)).then(r=>{if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return r.json()}).then(r=>r).then(r=>r.sources)}async callTool(e){let n=await fetch(this.postJSONRequest("tools/call",e));if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}async streamCompletionHelper(e,n,i,r){let p=new FormData;return e.forEach(o=>{p.append("history",JSON.stringify(o))}),n&&n.forEach(o=>{p.append("sources",JSON.stringify(o))}),i&&i.forEach(o=>{let d,c=j(o.value)||F(o.value);if(c){let u=c.split("/").pop(),l=x.default.readFileSync(c);p.append("files",new Blob([l]),u),d={...o,value:u}}else d={...o};p.append("references",JSON.stringify(d))}),r!==void 0&&p.append("token_limit",`${r}`),this.headers().set("Accept","text/event-stream"),fetch(this.postFormRequest("chat/vscode/stream",p)).then(o=>{if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);if(!o.body)throw new Error("HTTP error! no body");return o.body.getReader()})}async*streamCompletion(e,n,i,r){let p=await this.streamCompletionHelper(e,n,i,r);try{let y=new TextDecoder,o={};for(;;){let{done:d,value:c}=await p.read();if(d)break;let l=y.decode(c,{stream:!0}).split(`

`).filter(a=>a.trim()).map(a=>a.slice(6)).map(a=>JSON.parse(a));for(let a of l)if(a.type==="content")yield a;else{let s=Array.isArray(a.data)?a.data:[a.data];for(let E of s){let{id:m,index:h,function:R}=E;o[h]||(o[h]={id:m,function:{name:R?.name,arguments:""}}),R?.arguments&&(o[h].function.arguments+=R.arguments);try{let b=o[h].function.arguments,v=JSON.parse(b),_=typeof v=="string"?JSON.parse(v):v;yield{type:"tool_calls",data:[{id:o[h].id,function:{name:o[h].function.name,arguments:JSON.stringify(_)}}]},delete o[h]}catch{}}}}}finally{p.releaseLock()}}};var J={vendor:"copilot",family:"gpt-4o"},M=new g,$=async(t,e,n,i)=>{n.progress("Thinking...");let r,p,y=t.references.map(o=>{let d=o;return{...d,name:d.name||"unknown"}});switch(t.command){default:let[o]=await f.lm.selectChatModels(J),d=o.maxInputTokens,c=e.history?.map(l=>{if("prompt"in l)return{role:"user",content:l.prompt};if("response"in l){let a=l.response.filter(s=>s instanceof f.ChatResponseMarkdownPart).map(s=>s.value.value).join("");return a?{role:"assistant",content:a}:void 0}}).filter(l=>l!==void 0);c.push({role:"user",content:t.prompt});let u=[];for(;c[c.length-1].role!=="assistant";){n.progress("Finding references..."),c[c.length-1].role==="user"&&(u=await M.search(c)),[...new Set(u.filter(s=>s.url!==void 0).map(s=>f.Uri.parse(s.url)))].forEach(s=>n.reference(s)),n.progress("Thinking...");let l=[],a="";for await(let s of M.streamCompletion(c,u,y,d))s.type==="content"&&s.data?(a+=s.data,n.markdown(s.data)):s.type==="tool_calls"&&s.data&&l.push(...s.data);if(a&&c.push({role:"assistant",content:a}),l.length>0){let s=l.map(m=>({...m,type:"function"}));c.push({role:"assistant",tool_calls:s}),n.progress("Executing tools...");let E=await Promise.all(s.map(m=>M.callTool(m)));c.push(...E)}}}return{errorDetails:r,metadata:p}},O=$;function W(t){let e=T.chat.createChatParticipant(P,O);e.iconPath=T.Uri.joinPath(t.extensionUri,"icon.png")}0&&(module.exports={activate});
